require "test_helper"

class Book < ActiveRecord::Base
  has_neighbors :embedding
end

class LanternModelTextTest < Minitest::Test
  def setup
    @conn = ActiveRecord::Base.connection
    @conn.execute "DROP TABLE IF EXISTS books"
    @conn.execute <<~SQL
      CREATE TABLE books (
        id serial PRIMARY KEY,
        title text,
        embedding real[384]
      )
    SQL

    @books = [
      ["The Great Gatsby", [0.2243836,0.12383567,-0.06784898,0.24182758,0.6758062,-0.245531,0.22808352,0.17492759,-0.3593661,-0.13827589,0.023671709,0.12008238,0.83202875,0.37312323,-0.07353346,0.003996662,0.12909825,0.23161942,-0.697153,0.5328326,0.5914245,0.037161075,0.3816333,-0.46628237,0.14485078,-0.13558449,-0.3187515,-0.27441263,-0.3791316,-0.8444185,-0.42556506,0.059337094,0.48783445,-0.33632365,0.020622324,0.29552904,0.11841747,-0.22672889,0.15538791,-0.12453765,-0.4091958,0.07195169,-0.37933314,0.42881054,-0.22767454,0.09120959,0.05413328,0.14732675,0.064623825,-0.22805324,-0.78817713,0.22592816,-0.01575797,-0.017096832,0.1421639,0.5415548,0.5215514,-0.23533317,0.19049427,-0.41744712,0.12935211,0.059357047,-1.461744,0.53036845,0.7189093,0.6131904,-0.6251128,-0.2144438,0.09643847,-0.13971706,-0.5253104,0.005652271,0.3095269,0.2926203,-0.009626776,0.36212572,-0.106349215,-0.013438873,-0.4820326,0.06401717,0.16437751,0.02108039,-0.15670559,0.113531664,-0.28628206,-0.32736576,0.2614478,-0.2991972,-0.10710713,0.21523112,-0.2975542,0.11651774,-0.12142593,0.2574595,-0.2989618,-0.45378944,-0.07094182,0.21828699,0.13457453,2.827823,-0.6746046,0.16744617,0.2877674,-0.0023153499,0.19397405,-0.0030967742,0.2682271,-0.1984019,0.09564048,0.002975285,0.008214071,-0.23435646,1.1281867,0.08338398,0.10676197,0.54224575,0.34675574,-0.3957162,0.07740031,-0.0011546292,0.2901232,0.5313827,-0.5443877,-0.66015387,-0.19549577,-0.4220129,0.44658178,0.43045714,-0.4929781,-0.35425383,-0.0316858,0.21638125,-0.19261807,-0.106374666,0.11587377,0.36945865,-0.35769504,0.03897071,0.0077796504,-0.100645185,-0.29545224,-1.2872823,-0.8973816,0.0036808401,0.101813346,-0.14950979,0.1984717,0.6663378,-0.49038428,0.4097148,0.030863427,-0.6283988,0.08377083,0.11062364,0.1541586,0.054441966,0.4482854,0.9556101,-0.4627229,-0.12597115,-0.66088736,0.7669926,0.037348926,-0.8907076,0.57573885,-0.39675257,-0.09268649,0.108155325,-0.23419452,-0.30585364,0.048512973,0.37670752,-0.6440627,0.07141948,0.5935887,0.07377502,-0.04514503,0.50603694,-0.022560118,0.07012794,0.5662285,-0.22684082,-0.66396093,0.20778641,0.33299515,-0.2260396,0.17664209,-0.88343513,-0.22895813,0.3939882,0.8640316,0.5263981,0.2222915,-0.09995037,0.4111174,-0.32999718,-1.0521739,-0.19818687,-0.079029456,-0.11375988,-0.15767424,-0.9415243,-0.40147325,-0.077307835,0.20533209,0.24631113,0.39190274,-0.5059831,-0.030602321,0.38490245,0.011785254,0.0032217521,0.28657174,0.6578288,-0.337977,0.5774286,-0.25473168,0.24963878,-0.5316917,-0.12530816,0.45615727,-0.5976187,-0.8938367,-2.632929,0.017269151,0.08412088,-0.15635294,0.25476444,-0.3244648,0.049731568,0.2496168,0.2535308,0.662403,0.3651221,-1.1552837,-0.3409971,-0.3554747,0.0612553,0.06429742,-0.774144,0.2725913,-0.047733005,0.052336603,0.29339403,0.48052466,-0.6622682,0.21801567,-0.50807196,-0.18972799,1.550252,0.36670533,0.012100082,-0.059860785,0.27733505,0.11104196,-0.2613156,-0.22771098,-0.21427411,0.6761259,0.42115682,0.23799297,-0.20901878,-0.030712903,0.34046924,0.008402128,-0.071639106,-0.11008291,-0.5690801,0.15196845,0.0712159,-0.54256743,0.01418408,0.026403837,0.6243397,0.6477395,0.5768173,-0.16817486,-0.06220714,0.5083984,-0.6625807,0.28479862,-0.36767763,0.30984166,-0.29230538,0.69384277,-0.76542753,-0.260306,-0.1314785,0.10256458,-0.3935377,-0.12327792,0.08666203,-0.38190526,0.36209437,-0.84676576,-0.15160114,-0.45063943,-0.12065008,1.0030893,1.0608379,0.40860838,-0.5363146,-0.555105,-0.16327098,0.4440174,0.03989817,-0.17715657,0.58791006,-0.79254246,-0.30215174,-0.04415701,0.23523532,0.12440361,-0.029652102,-0.120938525,-0.32605332,-0.17775309,-0.321165,0.29654017,-1.9362643,0.16777974,-0.2680604,-0.17380783,0.06836696,0.31783655,-0.49153972,0.23225161,0.062482968,0.6779492,0.32332578,-0.38827053,0.22901177,-0.2900292,-0.45892182,0.11624308,0.4749571,0.45287412,-0.21502519,0.2031442,0.4490212,0.7624735,1.5952657,0.11606443,0.2534415,-0.09567617,-0.022049807,0.3905849,-0.29578182,-0.24802981,0.23233396,-0.02769705,0.4679225,-0.679554,0.07236383,0.9827056,-0.14324868,-0.04223557,-0.042742677,-0.10656239,-0.25161242,0.43696064,0.24389496,-0.014875632,1.073952,-0.37041953,-0.43721005,-0.086241364,-0.18407613,0.04948707,-0.44783404,0.1196634,0.11448838,0.17936759,-0.3860039,-0.1479388,0.5997514,0.4963491,-0.16656652,-0.500583,-0.11522004,-0.4769821,0.22700095,0.23134525,0.18383643]],
      ["The Hunger Games", [-0.4281298,-0.020524476,0.172569,0.14850098,0.12126149,0.20951293,-0.43155295,-0.29954317,0.036865093,0.30242458,-0.33793488,-0.029109165,-0.08831015,0.20521265,0.12889582,-0.31029838,0.2364801,-0.17815205,-1.2224795,0.37459853,0.3306262,-0.20993777,0.30831268,-0.37610078,0.024658985,-0.22602731,-0.10158922,0.068360515,-0.93238914,-0.74493086,0.36465293,-0.68740416,0.32273185,0.13750526,-0.3974854,0.52778447,0.3176764,0.29599077,-0.4970525,-0.24503934,0.1019891,0.0052946936,0.17272545,-0.11521489,-0.048831914,-0.7286426,-0.391432,-0.17135403,0.3424649,-0.27623588,-0.18515652,-0.12649739,-0.03664485,-0.004823357,-0.12007536,0.2179028,-0.07120377,-0.009025209,0.6145159,-0.3245515,0.10959582,-0.19591317,-1.7758782,0.9971339,1.0916588,0.65292394,0.18046331,0.060398497,0.041526936,-0.51150525,-0.22209261,0.6592395,0.92995137,0.6943855,-0.22347221,0.6510573,0.15401964,-0.25070733,-0.33765486,-0.194772,-0.030046977,-0.07490304,0.21717352,0.40832633,0.36255816,0.12737516,-0.053528257,0.11293267,0.61827743,0.1651872,-0.56092525,-0.22739157,0.1894882,0.1014289,-0.81063175,-0.41427585,0.07687386,-0.42784974,0.19874161,3.0592296,-0.266539,-0.13674356,-0.008235484,0.32125917,0.6187744,-0.56271917,0.27577993,-0.9166094,-0.22412986,-0.17333806,0.170969,-0.37299272,0.93211514,-0.25849706,0.01571586,0.52159804,0.40742907,0.15090774,0.19718522,0.20991533,-0.11087768,0.30380842,-0.5269527,-0.5270997,0.26250058,-0.587326,0.4789379,0.9798946,0.47778583,-0.41581708,0.2448005,0.045205936,-0.691419,0.31527615,-0.013310425,0.10830447,-0.35219043,-0.2255834,-0.103077784,-0.30538437,0.21829885,-0.64028716,-0.111509085,-1.1556767,-0.035118587,0.074118055,0.7194615,0.2417416,-0.20543936,1.0380423,0.017002054,0.03728723,-0.039652023,0.10763402,0.16407573,0.069067866,0.026424397,-0.010648079,-0.47521874,0.025351603,-0.13511702,0.013333365,-0.072735906,-0.9037132,0.32063723,-0.01926405,0.030001648,0.39795664,-0.12937614,0.17533213,-0.111228764,0.14475223,-0.6717342,0.14205328,0.37546605,-0.5115962,-0.5076126,-0.17513233,0.030295186,0.38572374,-0.4319688,-0.42989734,0.07021335,0.11387268,0.041382268,-0.390691,0.09100793,-0.53767896,0.3642457,0.57373273,0.48476243,-0.17117254,0.0307367,0.6119155,0.180957,0.10881671,0.38969794,-0.4904717,-0.35423106,-0.10184646,-0.49119025,-0.37998882,-0.51603293,0.08505808,0.2229664,-0.09001821,0.16298991,-0.4872455,0.64810973,0.17429233,-0.089415744,0.24832137,-0.17296645,-0.021488447,-0.5483475,-0.19820666,0.24693635,0.13193402,-0.6503468,0.25656047,0.4391989,-0.17506656,0.019692436,-2.7496789,0.092664376,0.15316774,-0.965585,-0.06448175,0.01742088,-0.16255108,-0.32294312,0.29119155,0.7339581,0.5480988,-0.7435078,-0.3155069,0.03651583,0.41306144,-0.74791664,-0.498989,0.2793694,-0.21736875,0.41421157,-0.22971456,-0.3282532,-0.3139856,-0.10605102,-0.24209154,0.48115546,1.3465198,1.2342283,0.24501868,-0.22525512,0.1783066,0.67918515,0.36127564,-0.81047636,0.30843088,0.4587173,0.3826009,0.10395381,-0.7432607,-0.31010357,-0.39509377,0.66269076,-0.17768212,-0.3436648,-0.32636845,-0.019188982,-0.105865575,0.65379584,0.26002982,0.41289937,-0.028668672,-0.2932123,0.5682462,-0.19869527,0.33748725,0.15031153,-0.39353526,0.50361186,0.2096003,0.5567111,-0.22510679,0.05249898,-0.6003151,0.21816567,0.22206539,0.14665726,-0.26423168,0.17770243,-0.25873315,-0.36038634,-0.4260935,-0.35406333,-0.3020971,-0.10398732,0.59138894,0.5058316,0.46553344,0.3442758,-0.21871881,-0.27685416,-0.0066058636,0.61432606,-0.37362415,0.21366675,0.39759272,0.043777738,0.048642244,-0.06738168,0.42378438,-0.06606639,-0.060072053,0.31278002,-0.49649408,0.08213793,-0.22598231,0.13930564,-1.9550678,0.5387809,0.16990544,0.45941728,0.12207222,-0.50593746,-0.053485915,0.5192886,0.2601744,0.19232957,0.6379928,-0.028052047,0.12063315,-0.38836735,-0.25863156,-0.04155484,0.6563641,-0.3407187,0.43767098,-0.60467774,0.6100758,0.03343096,1.7600652,-0.5237858,-0.48870295,0.17735112,0.3264292,0.32921642,-0.10586214,-0.18311258,0.45336446,0.20404205,-0.3757174,-0.0034908503,-0.21456823,-0.119853646,0.37524417,0.14613532,0.19857061,0.1694718,-0.169011,-0.06128279,0.15291595,-0.8483858,0.8810261,-0.20212008,-0.064956576,-0.42067218,0.17403567,-0.21225196,-0.21037582,-0.2474494,0.28097683,-0.08749328,0.24358389,-0.20307922,-0.17368257,-0.12631649,-0.17042163,0.1821545,-0.55630785,-0.102727465,-0.0908695,-0.01172246,0.19254439]],
      ["Merriam-Webster's Medical Dictionary", [-0.25677365,-0.059510812,-0.2972182,0.36719936,0.43044174,-0.24971071,1.0730138,0.6841083,-0.10931286,-0.061364245,-0.21508402,-0.72353625,0.13216242,0.11139825,0.0070584286,0.09611817,0.16251276,0.33752924,-0.45450988,0.47958827,0.6382466,0.38030028,0.40134165,-0.090579994,0.14078934,0.41275558,-0.27252004,0.1224803,-0.5833663,-0.6807842,-0.019830968,-0.11640997,0.023873411,0.4989456,-0.2594519,0.1734002,-0.37752149,0.6940018,-0.31805933,0.96512645,-0.34287316,0.46077105,-0.030109698,0.0018943772,0.13279344,-0.31292054,-0.70533717,-0.12993506,0.9092459,0.21546477,-0.43454164,-0.006801568,0.08138834,0.37310266,0.45677373,-0.15147354,-0.18721828,-0.022884563,-0.28705817,-0.13869186,0.47947928,0.6507198,-1.1660426,0.6420436,0.29542148,-0.06233266,-0.13092244,-0.06214136,-0.07603982,0.56491566,0.15189834,-0.0128477365,0.1667688,0.8698113,-0.17966165,-0.34839964,0.20350002,-0.71255714,0.3919902,0.30989742,0.27232242,0.76899743,0.10084441,-0.38975877,0.060214356,-0.42987388,-0.00050329417,-0.35672516,-0.22880816,-0.16494443,-0.5476605,-0.39968964,-0.543978,0.0936366,-0.59985435,-0.36395437,-0.13568555,-0.09413934,-0.14254269,3.4679613,-0.6284505,-0.11408031,-0.1863544,-0.44948974,0.2310546,-0.34699354,0.07342351,-0.4108086,-0.054758903,0.55607414,0.12690581,0.3190233,0.8622311,-0.044212677,-0.026457302,-0.42230532,0.08804154,0.06875137,0.7603136,0.77716535,-0.3860429,-0.12275031,0.19661246,-0.12494215,0.040068552,-0.47194624,0.63116324,1.35193,-0.042323112,0.04825697,0.19790487,0.67155045,-0.29736787,0.07503392,0.22493687,0.016788341,-0.060122304,-0.34732163,-0.22731864,0.32505825,-0.19607514,-0.8205571,-0.26388574,0.008826949,-0.49611333,1.0632188,-0.2712337,0.13223258,-0.35424295,0.14980234,0.051935285,0.35852215,-0.032832094,0.07963796,-0.20611277,0.2177177,0.77147895,-0.6805079,0.24415267,-0.50232893,0.56692153,-0.6099193,-0.5215981,0.987927,0.08609696,-0.39167303,-0.013232488,-0.4989466,0.21688505,-0.07001174,0.92230046,0.10775173,-0.44679478,0.64298856,0.15576963,0.14606759,-0.06377122,0.015760398,-0.051736705,-0.19211587,0.47692424,0.135055,-0.47020197,0.17690021,0.024949249,0.123695776,-0.14921045,-0.25362757,0.8708924,0.62798697,-0.1427628,-0.09558198,-0.19914909,-0.31423408,-0.4440223,-0.19096568,-0.55684566,-0.049706407,-0.047640413,-0.095445804,-0.07899569,-0.08012788,0.3525814,0.03270487,0.3694232,0.16385266,0.020132156,-0.07727134,0.16320142,0.21006392,-0.4504812,0.39595935,0.20587215,-0.00839477,-0.1515464,0.23821062,0.2736644,-0.016617142,-0.17310278,0.35874137,-0.042516842,-0.50965625,-0.3355813,-2.3627021,0.024229202,-0.3477592,-0.10416726,-0.08737905,-0.18901773,-0.13247436,-0.29297858,-0.081794426,-0.15386811,0.42916843,-0.3933981,-0.5031887,-0.474051,-0.26584837,0.14193445,0.24254426,-0.53614897,-0.28023654,0.39342225,0.55700296,0.17384097,0.51369405,-0.26358816,-0.45703846,0.02684817,1.2560177,0.16269264,-0.17723234,-0.06967102,0.08706404,0.09239663,0.04815706,-0.95410365,0.29735076,-0.15443335,-0.8935841,-0.27339232,-0.40212128,-0.03284252,-0.56673175,0.44161636,-0.06557695,0.13290204,-0.38443178,-0.7753768,-0.15619218,-0.070109636,-0.30771282,0.045845482,-0.095089465,0.20413867,0.044711024,0.120477244,0.2437776,0.04961486,-0.63582414,-0.09675424,-0.8694878,-0.49662638,0.13353296,0.37547722,0.19361228,-0.55561244,-0.2112602,-0.6437924,0.027537033,0.21139434,0.1548417,-0.1569119,-0.8318282,0.9784046,-0.14771861,0.043309435,-0.04236862,-0.046305165,0.32073057,-0.34701797,-0.69304997,-0.7169216,0.151104,-0.050733373,0.5582439,0.4055235,-0.032853268,-0.03268251,-0.012006104,0.029298328,0.4309555,-0.022562586,0.0048417477,0.44339606,-0.18206984,-0.21558367,-0.117477,0.09623755,-2.374367,0.33742717,0.5187043,0.37043515,-0.25571352,0.27884856,-0.06579372,-0.1771099,0.38020504,0.4107396,-0.31105214,-0.29832947,0.25577885,-0.5671954,-0.77605075,0.24407127,1.2874546,-0.75708735,0.18753606,0.15889816,0.16167794,-0.06528902,1.417969,-0.4123275,0.043646216,0.45088232,0.314564,0.26626673,-0.18234827,0.7050651,0.6788906,-0.19403546,0.3664187,0.5129787,0.31949812,0.44397616,-0.21417385,-0.11625753,0.4290015,-0.078889295,0.021442391,-0.17598249,-0.15218538,0.25808993,0.7026038,-0.09287651,0.1596998,-0.53327066,-0.52941006,-0.07477577,-0.4507498,-0.1137977,0.11298871,0.31788722,-0.064878166,-0.37368935,0.5893079,-0.43115544,0.09996636,-0.7387881,-0.5007944,-0.2912652,-0.12121382,0.64026356,0.07448105]]
    ]

    @books.each do |title, vector|
      Book.create(title: title, embedding: vector)
    end
  end

  # Helper method to test nearest neighbors with text
  def assert_class_nearest_neighbors(test_case)
    neighbors = Book.nearest_neighbors(:embedding, test_case[:query_text], 
                                    model: 'BAAI/bge-small-en',
                                    distance: test_case[:distance_metric]).limit(2)
    assert_equal test_case[:expected_neighbor_ids], neighbors.pluck(:id)
    assert neighbors.first.distance.is_a?(Numeric), "Distance should be numeric"
  end

  # Test cases for different distance metrics
  CLASS_DISTANCE_TEST_CASES = [
    {
      description: "L2 Distance with text",
      query_text: "A story about wealth and society",
      distance_metric: 'l2',
      expected_neighbor_ids: [1, 2]
    },
    {
      description: "Cosine Distance with text",
      query_text: "A story about medicine and health",
      distance_metric: 'cosine',
      expected_neighbor_ids: [3, 2]
    }
  ]

  # Dynamically define test methods
  CLASS_DISTANCE_TEST_CASES.each do |test_case|
    define_method("test_nearest_neighbors_#{test_case[:distance_metric]}") do
      assert_class_nearest_neighbors(test_case)
    end
  end

  def test_invalid_model
    assert_raises(ActiveRecord::StatementInvalid) do
      Book.nearest_neighbors(:embedding, "test", 
                           model: 'invalid/model',
                           distance: 'l2').limit(2).to_a
    end
  end

  def teardown
    @conn.execute "DROP TABLE IF EXISTS books"
  end
end